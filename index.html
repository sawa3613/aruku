<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>高知市 散歩コース自動生成（行き帰り別＆見やすい版）</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; }
    #controls {
      padding: 10px;
      background: #f4f4f4;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #map { height: calc(100vh - 70px); }
    button { padding: 6px 14px; cursor: pointer; }
  </style>
</head>
<body>

<div id="controls">
  <label>
    距離(km):
    <input type="number" id="distance" value="5" step="0.5" min="1">
  </label>

  <label>
    モード:
    <select id="mode">
      <option value="kochiplan">高知らしいおすすめ散歩</option>
      <option value="random">完全ランダム散歩</option>
    </select>
  </label>

  <label>
    雰囲気:
    <select id="mood">
      <option value="quiet">静か</option>
      <option value="lively">にぎやか</option>
    </select>
  </label>

  <button onclick="createRoute()">散歩コース作成</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===============================
   初期設定
=============================== */

const START = [33.5597, 133.5311]; // 高知城
const map = L.map("map").setView(START, 14);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap contributors"
}).addTo(map);

L.marker(START).addTo(map).bindPopup("スタート：高知城");

let routeLayer = [];

/* ===============================
   スポット
=============================== */

const kochiSpots = [
  { lat: 33.5595, lng: 133.5319, mood: "lively" },
  { lat: 33.5618, lng: 133.5245, mood: "quiet" },
  { lat: 33.5509, lng: 133.5206, mood: "quiet" },
  { lat: 33.5488, lng: 133.5162, mood: "quiet" }
];

/* ===============================
   メイン
=============================== */

function createRoute() {
  const targetKm = Number(document.getElementById("distance").value);
  const mode = document.getElementById("mode").value;
  generateRoute(targetKm, mode === "random");
}

/* ===============================
   距離補正＋行き帰り別ルート生成
=============================== */

async function generateRoute(targetKm, random) {
  const halfKm = targetKm / 2;
  let radius = halfKm / 111;

  let outPoints, returnPoints, outRoute, returnRoute;

  // 行きと帰りの折返地点
  if(random){
    outPoints = createRandomOutAndBack(radius);
    returnPoints = [outPoints[0], outPoints[2], outPoints[1], outPoints[3]];
  } else {
    outPoints = createMoodOutAndBack(radius);
    returnPoints = [outPoints[0], outPoints[2], outPoints[1], outPoints[3]];
  }

  // OSRMで経路取得
  outRoute = await fetchRoute(outPoints);
  returnRoute = await fetchRoute(returnPoints);

  drawSeparateRoutes(outRoute.geometry, returnRoute.geometry);
}

/* ===============================
   高知らしい行き帰り別ルート
=============================== */

function createMoodOutAndBack(radius) {
  const mood = document.getElementById("mood").value;
  const candidates = kochiSpots.filter(s => s.mood === mood);

  const outSpot = candidates[Math.floor(Math.random() * candidates.length)];
  const returnSpot = candidates[Math.floor(Math.random() * candidates.length)];

  const points = [
    START,
    [START[0] + (outSpot.lat - START[0]) * radius*3,
     START[1] + (outSpot.lng - START[1]) * radius*3],
    [START[0] + (returnSpot.lat - START[0]) * radius*3,
     START[1] + (returnSpot.lng - START[1]) * radius*3],
    START
  ];
  return points;
}

/* ===============================
   完全ランダム行き帰り別ルート
=============================== */

function createRandomOutAndBack(radius) {
  const angle1 = Math.random() * Math.PI*2;
  const angle2 = Math.random() * Math.PI*2;
  const lat1 = START[0] + Math.cos(angle1) * radius;
  const lng1 = START[1] + Math.sin(angle1) * radius;
  const lat2 = START[0] + Math.cos(angle2) * radius * 0.9;
  const lng2 = START[1] + Math.sin(angle2) * radius * 0.9;

  return [START, [lat1,lng1], [lat2,lng2], START];
}

/* ===============================
   OSRM取得
=============================== */

async function fetchRoute(points) {
  const coords = points.map(p => `${p[1]},${p[0]}`).join(";");
  const url = `https://router.project-osrm.org/route/v1/foot/${coords}?overview=full&geometries=geojson`;
  const res = await fetch(url);
  const data = await res.json();
  return data.routes[0];
}

/* ===============================
   描画（行き帰り別ルート＆色分け）
=============================== */

function drawSeparateRoutes(outGeo, returnGeo){
  // 古いルート削除
  routeLayer.forEach(l => map.removeLayer(l));
  routeLayer = [];

  // 行き：青
  const outLine = L.geoJSON(outGeo, { style: { color: "blue", weight: 5 } }).addTo(map);
  routeLayer.push(outLine);

  // 帰り：赤＆微小オフセットで重なり回避
  const offsetGeo = JSON.parse(JSON.stringify(returnGeo));
  offsetGeo.coordinates = offsetGeo.coordinates.map(c => [c[0]+0.00005, c[1]+0.00005]);
  const returnLine = L.geoJSON(offsetGeo, { style: { color: "red", weight: 5 } }).addTo(map);
  routeLayer.push(returnLine);

  map.fitBounds(L.featureGroup(routeLayer).getBounds());
}
</script>

</body>
</html>
